<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AFBR-S50 API Reference Manual: Troubleshooting</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="AFBR-S50.ico"/></td>
  <td id="projectalign">
   <div id="projectname">AFBR-S50 API Reference Manual<span id="projectnumber">&#160;v1.6.5</span>
   </div>
   <div id="projectbrief">AFBR-S50 Time-of-Flight Sensor SDK for Embedded Software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('faq.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Troubleshooting</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__doxygen_299__troubleshooting"></a></p>
<p>The following section contains troubleshooting guidance for the most common issues. Please also refer to the <a class="el" href="porting_guide.html#hal_self_test">HAL Self Test</a> module that runs a few test cases in order to verify the HAL, e.g. after <a class="el" href="porting_guide.html">porting the API to a new platform</a>.</p>
<h1><a class="anchor" id="autotoc_md76"></a>
Device Initialization Yields Device Not Connected (Error Code -101)</h1>
<p><b>Problem</b>: After calling the <a class="el" href="group__argus__api.html#ga7d724a6657138f112bff554f7db2a898" title="Initializes the device with default measurement mode.">Argus_Init()</a> method, an error status -101 (<a class="el" href="group__argus__status.html#gga67a0db04d321a74b7e7fcfd3f1a3f70baa1e50bb51331e898a5b3a6662a770016">ERROR_ARGUS_NOT_CONNECTED</a>) is returned.</p>
<p><b>Information</b>: The first thing that happens in the initialization function are a few read/write cycles on the SPI interface in order to check the responsiveness of the device:</p>
<ul>
<li>First, a byte sequence (1,2,3,4,...,16) is written to the MOSI and the MISO data is ignored.</li>
<li>Second, a sequence of 0's is written to the same register and the MISO is captured and compared to the pattern from the previous write cycle.</li>
<li>Finally, another sequence of 0's is written and the received data is checked for being zero again.</li>
</ul>
<p>If the read pattern is not equal to the written one, the error <a class="el" href="group__argus__status.html#gga67a0db04d321a74b7e7fcfd3f1a3f70baa1e50bb51331e898a5b3a6662a770016">ERROR_ARGUS_NOT_CONNECTED</a> is returned and the initialization process is canceled.</p>
<p><b>Solution</b>: In order to solve the issue, verify the following sequence in your SPI interface when calling the <a class="el" href="group__argus__api.html#ga7d724a6657138f112bff554f7db2a898" title="Initializes the device with default measurement mode.">Argus_Init()</a> function:</p>
<ol type="1">
<li>Writing a test pattern to register address 0x04:<ul>
<li>MOSI: <code>0x 04 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 10</code></li>
<li>MISO: <code>0x 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</code> (or any other, depending on the current state of your device)</li>
</ul>
</li>
<li>Clearing the test pattern at register 0x04, read back of test pattern 1:<ul>
<li>MOSI: <code>0x 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</code></li>
<li>MISO: <code>0x 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 10</code></li>
</ul>
</li>
<li>Clearing the test pattern at register 0x04, read back of test pattern 2:<ul>
<li>MOSI: <code>0x 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</code></li>
<li>MISO: <code>0x 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</code></li>
</ul>
</li>
</ol>
<p>If the above pattern is not present, double check the following:</p>
<ul>
<li>Verify the physical connections of all 4 SPI pins: MOSI, MISO, CS and CLK.</li>
<li>Verify the correct implementation of the <a class="el" href="group__argus__s2pi.html#ga0c8f883938de571dbd73033b4957a987" title="Transfers a single SPI frame asynchronously.">S2PI_TransferFrame</a> method and all its requirements (e.g. any required initialization code is properly called prior to <a class="el" href="group__argus__api.html#ga7d724a6657138f112bff554f7db2a898" title="Initializes the device with default measurement mode.">Argus_Init</a>).</li>
<li>Further check if the <code>spi_slave</code> parameter in the <a class="el" href="group__argus__api.html#ga7d724a6657138f112bff554f7db2a898" title="Initializes the device with default measurement mode.">Argus_Init</a> function is correct and not 0! Passing 0 is reserved for error handling!</li>
</ul>
<h1><a class="anchor" id="autotoc_md77"></a>
Decreased Device Performance or Accuracy</h1>
<p><b>Problem</b>: The measurement data is not very accurate, the performance is bad and the sensor seems to be uncalibrated.</p>
<p><b>Information</b>: Each sensor is factory calibrated and comes with its individual set of calibration data stored in a small EEPROM on the ASIC. If EEPROM readout fails, the sensor remains uncalibrated and measurement results are no good. Furthermore, the module and laser type cannot be identified and this the device operates in a low output power mode in order to stay eye safe yielding bad performance.</p>
<p><b>Solution</b> Verify the EEPROM readout is working. Refer to the <a class="el" href="#faq_eeprom">EEPROM</a> section for details.</p>
<h1><a class="anchor" id="faq_eeprom"></a>
EEPROM Readout Fails (Error Code -109)</h1>
<p><b>Problem</b>: The EEPROM readout does not work correctly and the <a class="el" href="group__argus__api.html#ga7d724a6657138f112bff554f7db2a898" title="Initializes the device with default measurement mode.">Argus_Init</a> return with error code -109 (<a class="el" href="group__argus__status.html#gga67a0db04d321a74b7e7fcfd3f1a3f70ba92cbdc0cd1fcb54b379782db56258663">ERROR_ARGUS_EEPROM_FAILURE</a>). The device does not operate with expected performance and accuracy.</p>
<p><b>Failure Modes:</b> In case of EEPROM readout issues, the following failure modes are possible and need to be verified:</p>
<ol type="1">
<li>GPIO output does not work.</li>
<li>GPIO input does not work.</li>
<li>GPIO signals are inverted.</li>
<li>GPIO direction (input/output) is not correct.</li>
<li>GPIO timing is too fast.</li>
</ol>
<h2><a class="anchor" id="autotoc_md78"></a>
1. How to Verify EEPROM Readout Sequence</h2>
<p>If EEPROM readout fails, verify the readout sequence by executing the following steps:</p>
<ol type="1">
<li>Set Breakpoints at the start of <a class="el" href="group__argus__s2pi.html#ga48abf1c772d2f89436cba9c32a1cdcaf" title="Captures the S2PI pins for GPIO usage.">S2PI_CaptureGpioControl</a> and at the end of <a class="el" href="group__argus__s2pi.html#ga35cc8f0eeec245733773f34bd5985772" title="Releases the S2PI pins from GPIO usage and switches back to SPI mode.">S2PI_ReleaseGpioControl</a> functions respectively.</li>
<li>Run your code with <a class="el" href="group__argus__api.html#ga7d724a6657138f112bff554f7db2a898" title="Initializes the device with default measurement mode.">Argus_Init</a> and wait until the breakpoint within <a class="el" href="group__argus__s2pi.html#ga48abf1c772d2f89436cba9c32a1cdcaf" title="Captures the S2PI pins for GPIO usage.">S2PI_CaptureGpioControl</a> hits and the program execution stops.</li>
<li>Start recording the SPI signals and pins MOSI, MISO, CLK and CS with a Logic Analyzer or an Oscilloscope.</li>
<li>Stop the recording when the program execution stops at the breakpoint within <a class="el" href="group__argus__s2pi.html#ga35cc8f0eeec245733773f34bd5985772" title="Releases the S2PI pins from GPIO usage and switches back to SPI mode.">S2PI_ReleaseGpioControl</a>.</li>
<li>Verify the captured sequence and compare it to the following screenshot:</li>
</ol>
<div class="image">
<img src="faq_eeprom.png" alt="" width="66%"/>
<div class="caption">
EEPROM Readout Sequence (Signals from top to bottom: MOSI, MISO, CLK, CS).</div></div>
 <p><b>Things to verify:</b></p>
<ol type="1">
<li>Check if output (CS, MOSI, CLK) pins are toggling. If no signal changes, check the implementation of your <a class="el" href="group__argus__s2pi.html#gaf4e0e0945f3abef86ed42aaecf2ff861" title="Writes the output for a specified SPI pin in GPIO mode.">S2PI_WriteGpioPin</a> function. Also verify the output signals are at 3.3 V level.</li>
<li>Check if CLK toggles at approx. 10 to 100 kHz or slower. Add a delay (e.g. 10µsec) in the <a class="el" href="group__argus__s2pi.html#gaf4e0e0945f3abef86ed42aaecf2ff861" title="Writes the output for a specified SPI pin in GPIO mode.">S2PI_WriteGpioPin</a> function to limit GPIO toggling speed.</li>
</ol>
<p><b>Additional Info:</b> Here is some additional info about the EEPROM protocol to better understand and verify what's going on: Whenever the CS is cleared to low, the transfer always begins with an standard 8-bit SPI sequence. Some transfers include a 7-bit EEPROM read command plus address or an 8-bit EEPROM data byte. In detail, the following transfers are happening per readout sequence:</p>
<ol type="1">
<li>The first transfer is a SPI write of byte 0x2C followed by a 7-bit EEPROM read command plus address. The EEPROM data on the MOSI is echoed one bit later at the MISO line.</li>
<li>The next transfer is simply a 8-bit SPI transfer of byte 0x2C.</li>
<li>The third transfer is the read access. 0x2F SPI write followed by a 8-bit EEPROM read sequence. The EEPROM bits are transferred via the MISO line.</li>
<li>Finally, the sequence is closed with a 0x2C SPI write access.</li>
</ol>
<h2><a class="anchor" id="autotoc_md79"></a>
2. Further Tests on EEPROM Readout Sequence</h2>
<p>If the EEPROM sequence is verified as described above, apply these additional tests to eliminate the remaining failure modes:</p>
<ol type="1">
<li>Test if the GPIO input value is correctly read within the <a class="el" href="group__argus__s2pi.html#ga3695298d452f8af4a4bcbff930636cdc" title="Reads the input from a specified SPI pin in GPIO mode.">S2PI_ReadGpioPin</a> function. Use a debugger breakpoint within <a class="el" href="group__argus__s2pi.html#ga3695298d452f8af4a4bcbff930636cdc" title="Reads the input from a specified SPI pin in GPIO mode.">S2PI_ReadGpioPin</a> to stop the program execution and verify that the current input voltage (determined by multimeter or oscilloscope) yields the correct return value.<ul>
<li>Double check if a low voltage (0V, GND) level yield 0 and a high voltage (3V3, VCC) level yield 1 respectively.</li>
<li>Repeat the test until at least a single low and high state has been tested.</li>
<li>Also make sure the voltage level is at 3.3 V.</li>
</ul>
</li>
<li>Double check input/output GPIO direction configuration:<ul>
<li>Output Pins: CLK, CS, MOSI</li>
<li>Input Pins: MISO, IRQ</li>
</ul>
</li>
<li>Measure the GPIO toggle speed of the CLK pin with an oscilloscope. Add a delay in the S2PI_WriteGpioPin function to limit GPIO toggling speed to around 10µsec.</li>
</ol>
<h1><a class="anchor" id="autotoc_md80"></a>
The Measurement Never Finishes or Yields Timeout Error (-6)</h1>
<p><b>Problem</b>: After starting a measurement,via <a class="el" href="group__argus__meas.html#ga4c115715544c1f66cf39f1a1f649f093" title="Triggers a single measurement frame asynchronously.">Argus_TriggerMeasurement</a> or <a class="el" href="group__argus__meas.html#gabe59a112f841d59e435510d3c17c9db1" title="Starts the timer based measurement cycle asynchronously.">Argus_StartMeasurementTimer</a>, the callback is never invoked or the passed callback status is -6 (Timeout).</p>
<p><b>Information</b>: After starting a measurement or integration cycle on the device, the API waits until a callback is invoked via a GPIO interrupt. Usually the interrupt implementation is invalid when facing the above problem.</p>
<h2><a class="anchor" id="autotoc_md81"></a>
The Measurement Finished Callback is Never Invoked</h2>
<p>When the measurement ready callback is never invoked and no timeout error occurs, the device interrupt is pending and the <a class="el" href="group__argus__s2pi.html#gad2608e23e402fcf759d57a7ff7c453e6" title="Reads the current interrupt pending status of the IRQ pin.">S2PI_ReadIrqPin</a> function correctly determines the low state of the interrupt pin. However, the interrupt service routine is not invoked or does not call the required callback into the API.</p>
<p><b>Solution</b>: Double check the IRQ implementation:</p>
<ul>
<li>Check if the interrupt invokes the interrupt service routine on a falling edge.</li>
<li>Check if the interrupt service routine calls the previously set callback into the API. The callback is passed upon initialization (<a class="el" href="group__argus__api.html#ga7d724a6657138f112bff554f7db2a898" title="Initializes the device with default measurement mode.">Argus_Init</a>) via the <a class="el" href="group__argus__s2pi.html#ga8e2c5cf733c131a0856ee3c3d073b29c" title="Set a callback for the GPIO IRQ for a specified S2PI slave.">S2PI_SetIrqCallback</a> function.</li>
<li>Check if the interrupt priorities are set correctly. Refer to the <a class="el" href="porting_guide.html#pg_irq">Porting Guide</a> for further information.</li>
</ul>
<h2><a class="anchor" id="autotoc_md82"></a>
The Measurement Finished Callback Yield a Timeout Error (Error Code -6)</h2>
<p>When the measurement ready callback is invoked but passes a timeout error (-6) via the status parameter, the device interrupt is not detected at all. This may stem from invalid SPI transfers (i.e. device configuration already fails) or invalid IRQ implementation. Since the <a class="el" href="group__argus__api.html#ga7d724a6657138f112bff554f7db2a898" title="Initializes the device with default measurement mode.">Argus_Init</a> function already passes with status OK, the SPI communication should be valid.</p>
<p><b>Solution</b>: Double check the IRQ implementation:</p>
<ul>
<li>Check if the interrupt line is pulled to low after starting the measurements (e.g. via <a class="el" href="group__argus__meas.html#ga4c115715544c1f66cf39f1a1f649f093" title="Triggers a single measurement frame asynchronously.">Argus_TriggerMeasurement</a>). If this is not the case, double check the physical connection and SPI communication.</li>
<li>Check if the <a class="el" href="group__argus__s2pi.html#gad2608e23e402fcf759d57a7ff7c453e6" title="Reads the current interrupt pending status of the IRQ pin.">S2PI_ReadIrqPin</a> reads the IRQ line state correctly (low level (0V) yields 0, high level (3.3V) yields 1)</li>
<li>Check if the interrupt invokes the interrupt service routine on a falling edge.</li>
<li>Check if the interrupt service routine calls the previously set callback into the API. The callback is passed upon initialization (<a class="el" href="group__argus__api.html#ga7d724a6657138f112bff554f7db2a898" title="Initializes the device with default measurement mode.">Argus_Init</a>) via the <a class="el" href="group__argus__s2pi.html#ga8e2c5cf733c131a0856ee3c3d073b29c" title="Set a callback for the GPIO IRQ for a specified S2PI slave.">S2PI_SetIrqCallback</a> function.</li>
<li>Check if the interrupt priorities are set correctly. Refer to the <a class="el" href="porting_guide.html#pg_irq">Porting Guide</a> for further information. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath">
	<!-- id is needed for treeview function! -->
	<ul>
		<li class="footer"> 
			<a href="https://www.broadcom.com/">Broadcom Inc.</a>
		</li>
	</ul>
</div>
</body>
</html>
