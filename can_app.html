<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AFBR-S50 API Reference Manual: CAN App (AFBR-S50 Ref. Board)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="AFBR-S50.ico"/></td>
  <td id="projectalign">
   <div id="projectname">AFBR-S50 API Reference Manual<span id="projectnumber">&#160;v1.6.5</span>
   </div>
   <div id="projectbrief">AFBR-S50 Time-of-Flight Sensor SDK for Embedded Software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('can_app.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">CAN App (AFBR-S50 Ref. Board)</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__doxygen_205__30__can__app"></a></p>
<p>The <a class="el" href="reference_board.html">AFBR-S50 Reference Board</a> by <b>MikroElektronika</b> runs with a simple CAN demo application, the <b>CAN App</b>.</p>
<div class="image">
<img src="6_1_reference_design.jpg" alt="" width="240px"/>
<div class="caption">
Fig. 6.1: The Reference Design by MikroElektronika.</div></div>
 <p>It provides a CAN connection to another Node that is starting and stopping the TOF measurements.</p>
<dl class="section note"><dt>Note</dt><dd>The <a class="el" href="reference_board.html">AFBR-S50 Reference Board</a> is quite new and thus the corresponding documentation and code projects are still under construction and will be periodically updated. Please feel free to contribute and submit an issue or pull-request on the <a href="https://github.com/Broadcom/AFBR-S50-API">AFBR-S50 GitHub repository</a> or reach out to the Broadcom TOF Support Team: <a href="#" onclick="location.href='mai'+'lto:'+'sup'+'po'+'rt.'+'TO'+'F@b'+'ro'+'adc'+'om'+'.co'+'m'; return false;">suppo<span class="obfuscator">.nosp@m.</span>rt.T<span class="obfuscator">.nosp@m.</span>OF@br<span class="obfuscator">.nosp@m.</span>oadc<span class="obfuscator">.nosp@m.</span>om.co<span class="obfuscator">.nosp@m.</span>m</a></dd></dl>
<h1><a class="anchor" id="autotoc_md49"></a>
Flash the CAN App via USB Bootloader</h1>
<p>See <a class="el" href="reference_board.html#reference_board_bootloader">Bootloader</a> for details.</p>
<h1><a class="anchor" id="can_app_e2Studio"></a>
Build And Run the CAN App using e² Studio IDE</h1>
<p>In order to run the provided <b>CAN App</b> project using the <b>e² Studio IDE</b> by <b>Renesas</b>, follow the steps in the <a class="el" href="e2studio.html">e² Studio IDE</a> section to import, build and run/debug the <b>AFBR_S50_CANApp_RA4M2</b> project. Skip steps that connect to UART and connect to via CAN-Bus software instead.</p>
<h1><a class="anchor" id="autotoc_md50"></a>
Using the CAN App</h1>
<p>See the <a class="el" href="reference_board.html#reference_board_can">CAN-Bus Connector</a> section on more details on how to connect to the <a class="el" href="reference_board.html">AFBR-S50 Reference Board</a> via CAN-Bus.</p>
<p>Once the connection is established and the board is powered, it waits for the measurement start command. The start command can be provided by CAN or UART. After receiving the start command, it starts streaming (1D) measurement data via CAN interface until a stop measurements command is received. Here is an overview of currently available CAN commands:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">ID   </th><th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Data   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x08   </td><td class="markdownTableBodyNone">Remote   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">Start Measurements   </td><td class="markdownTableBodyNone">Start the measurement cycle on the board.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x09   </td><td class="markdownTableBodyNone">Remote   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">Stop Measurements   </td><td class="markdownTableBodyNone">Stops the measurement cycle on the board.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x28   </td><td class="markdownTableBodyNone">Data   </td><td class="markdownTableBodyNone">8-bytes   </td><td class="markdownTableBodyNone">1D Measurement Data   </td><td class="markdownTableBodyNone">A set of 1D measurement data including range, amplitude, status and signal quality values.   </td></tr>
</table>
<p>Data Frame (0x28) Description:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Value   </th><th class="markdownTableHeadNone">Units   </th><th class="markdownTableHeadNone">Bytes   </th><th class="markdownTableHeadNone">Data Type   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Range   </td><td class="markdownTableBodyNone">mm   </td><td class="markdownTableBodyNone">0-2   </td><td class="markdownTableBodyNone">24-bit unsigned int   </td><td class="markdownTableBodyNone">Range value in millimeters.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Amplitude   </td><td class="markdownTableBodyNone">LSB   </td><td class="markdownTableBodyNone">3-4   </td><td class="markdownTableBodyNone">16-bit unsigned int   </td><td class="markdownTableBodyNone">Amplitude value in LSB.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Signal Quality   </td><td class="markdownTableBodyNone">%   </td><td class="markdownTableBodyNone">5   </td><td class="markdownTableBodyNone">8-bit unsigned int   </td><td class="markdownTableBodyNone">Signal Quality in % (1: bad, 100: good; 0: n/a)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Status   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">6-7   </td><td class="markdownTableBodyNone">16-bit signed int   </td><td class="markdownTableBodyNone">Measurement Status (0: OK, &lt;0: Error, &gt;0 Warning/Status, see <a class="el" href="group__argus__status.html#gaaabdaf7ee58ca7269bd4bf24efcde092" title="Type used for all status and error return values.">status_t</a> for details)   </td></tr>
</table>
<p>Here is an overview of currently available UART commands: </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Character   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">s   </td><td class="markdownTableBodyNone">Start Measurements   </td><td class="markdownTableBodyNone">Starts the measurement cycle on the board.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">p   </td><td class="markdownTableBodyNone">Stop Measurements   </td><td class="markdownTableBodyNone">Stops the measurement cycle on the board.   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md51"></a>
Communication Interface CAN</h1>
<h2><a class="anchor" id="autotoc_md52"></a>
Introduction</h2>
<p>A <b>Controller Are Network (CAN)</b> is a robust bus standard designed to communicate with each others applications without a host. The protocol is message-based. The data in a frame is transmitted serially, but if more than one node is transmitting at the same time, the highest priority device can continue while the others back off. Every Node is receiving the same frames.</p>
<p>CAN is a multi-master serial bus standard for nodes. Two or more nodes are required. The bus uses differential wired-AND signals, a physically conventional two wire bus. CAN High and CAN Low signal is terminated with 120 Ohm characteristic impedance.</p>
<h2><a class="anchor" id="autotoc_md53"></a>
Architecture</h2>
<p>The CAN protocol defines the data link layer and part of the physical layer in the OSI model.</p>
<p>To sum up:</p>
<ol type="1">
<li>Physical Layer: Bit encoding/decoding, driver/receiver characteristics, connectors</li>
<li>Data Link Layer: data framing, serialization/deserialization, error detection</li>
</ol>
<h2><a class="anchor" id="autotoc_md54"></a>
Bus levels</h2>
<p>CAN specifies two logical levels: recessive and dominant. At the ISO-11898 recessive and dominant states are defines as differential voltages. The recessive state is defined as logical <code>1</code>, and for the dominants it is defined as logical <code>0</code>.</p>
<h2><a class="anchor" id="autotoc_md55"></a>
CAN Frames</h2>
<h3><a class="anchor" id="autotoc_md56"></a>
Data Frame</h3>
<p>Basis frame according ISO 11898-1:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Start   </th><th class="markdownTableHeadNone">Identifier   </th><th class="markdownTableHeadNone">RTR   </th><th class="markdownTableHeadNone">IDE   </th><th class="markdownTableHeadNone">r0   </th><th class="markdownTableHeadNone">DLC   </th><th class="markdownTableHeadNone">DATA   </th><th class="markdownTableHeadNone">CRC   </th><th class="markdownTableHeadNone">ACK   </th><th class="markdownTableHeadNone">EOF+IFS    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1Bit   </td><td class="markdownTableBodyNone">11Bit   </td><td class="markdownTableBodyNone">1Bit   </td><td class="markdownTableBodyNone">1Bit   </td><td class="markdownTableBodyNone">1Bit   </td><td class="markdownTableBodyNone">4Bit   </td><td class="markdownTableBodyNone">0..8Bytes   </td><td class="markdownTableBodyNone">16Bit   </td><td class="markdownTableBodyNone">2Bit   </td><td class="markdownTableBodyNone">10Bit   </td></tr>
</table>
<p>Extended-Frame according ISO 11898-1:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Start   </th><th class="markdownTableHeadNone">Identifier   </th><th class="markdownTableHeadNone">SRR   </th><th class="markdownTableHeadNone">IDE   </th><th class="markdownTableHeadNone">Identifier   </th><th class="markdownTableHeadNone">RTR   </th><th class="markdownTableHeadNone">r1   </th><th class="markdownTableHeadNone">r0   </th><th class="markdownTableHeadNone">DLC   </th><th class="markdownTableHeadNone">Data   </th><th class="markdownTableHeadNone">CRC   </th><th class="markdownTableHeadNone">ACK   </th><th class="markdownTableHeadNone">EOF+IFS    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1Bit   </td><td class="markdownTableBodyNone">11Bit   </td><td class="markdownTableBodyNone">1Bit   </td><td class="markdownTableBodyNone">1Bit   </td><td class="markdownTableBodyNone">18Bit   </td><td class="markdownTableBodyNone">1Bit   </td><td class="markdownTableBodyNone">1Bytes   </td><td class="markdownTableBodyNone">1Bit   </td><td class="markdownTableBodyNone">4Bit   </td><td class="markdownTableBodyNone">0..8Bytes   </td><td class="markdownTableBodyNone">16Bit   </td><td class="markdownTableBodyNone">2Bit   </td><td class="markdownTableBodyNone">10Bit   </td></tr>
</table>
<ul>
<li>Start: for</li>
<li>Identifier: information for receiver and priority for bus arbitration</li>
<li>RTR: difference between data- and RTR- telegram</li>
<li>IDE: Identifier Extension</li>
<li>r0,r1: reserved</li>
<li>DLC: information of length of the following data field</li>
<li>DATA: data field</li>
<li>CRC: CRC checksum</li>
<li>ACK: acknowledge of other node if receiving was successful</li>
<li>EOF: end of data telegram</li>
<li>IFS: space in between CAN frames</li>
<li>SRR: replaces RTR bit in extended frame</li>
<li>IDE shows, that further 18 bits are following</li>
</ul>
<h3><a class="anchor" id="autotoc_md57"></a>
Remote Frame</h3>
<p>With sending a remote frame a node is requesting the data from the source.</p>
<h3><a class="anchor" id="autotoc_md58"></a>
Error Frame</h3>
<p>An Error frame consists of 2 fields:</p>
<ol type="1">
<li>Error Flags</li>
<li>Error Delimiter There are two types of error flags:</li>
</ol>
<ul>
<li>Active error flag:</li>
<li>Passive error flag</li>
</ul>
<p>//TODO</p>
<h2><a class="anchor" id="autotoc_md59"></a>
Bus Access Method</h2>
<p>CAN uses a <b>Carrier Sense Multiple Access/ Collision Avoidance (CSMA/CA)</b> method. It checks whether the bus is occupied or not (carrier sense). With sending simultaneously (multiple access) the arbitration process will be effective.</p>
<h2><a class="anchor" id="autotoc_md60"></a>
Arbitration Process</h2>
<p>There are some arbitration levels to follow</p>
<ol type="1">
<li>The lowest identifier has the highest priority</li>
<li>The level of the RTR bit (dominant before recessive)</li>
<li>The IDE bit ( dominant before recessive)</li>
<li>extended frame (second identifier of 18 bits)</li>
<li>RTR bit of extended frame</li>
</ol>
<p>If there's always no difference between the frames, an bit error will occur.</p>
<h2><a class="anchor" id="autotoc_md61"></a>
Error handling</h2>
<p>TODO </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath">
	<!-- id is needed for treeview function! -->
	<ul>
		<li class="navelem"><a class="el" href="apps.html">Demo Applications</a></li>
		<li class="footer"> 
			<a href="https://www.broadcom.com/">Broadcom Inc.</a>
		</li>
	</ul>
</div>
</body>
</html>
