<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AFBR-S50 API Reference Manual: Architectural Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="AFBR-S50.ico"/></td>
  <td id="projectalign">
   <div id="projectname">AFBR-S50 API Reference Manual<span id="projectnumber">&#160;v1.6.5</span>
   </div>
   <div id="projectbrief">AFBR-S50 Time-of-Flight Sensor SDK for Embedded Software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('sw_api.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Architectural Overview</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__doxygen_202__architecture"></a></p>
<h1><a class="anchor" id="sw_api_overview"></a>
Overview</h1>
<p>See the <a class="el" href="#sw_architecture">Fig. 2.1</a> for an brief overview on the integration of the <em>AFBR-S50 Core Library</em> and API into the users application and hardware platform. The architecture is split into two parts: hardware and software. The hardware contains the <em>AFBR-S50</em> sensor device. It is connected to the processor and its peripherals via an SPI interface. An additional GPIO pin is required for the measurement data ready event from the sensor device.</p>
<p>The software that runs on the processor is essentially build from three parts: The <em>user application</em>, holding application specific code, is implemented by the user. The <em>AFBR-S50 Core Library</em> consists of sensor hardware specific code, an corresponding API and the hardware abstraction layers (HAL). The latter defines the required interface for the <em>AFBR-S50 Core Library</em> to access the hardware and is implemented platform dependent in the user application.</p>
<p>The <em>AFBR-S50 Core Library</em> comes as a pre-compiled <em>ANSI-C</em> library (i.e. a "lib\*.a" file) file that contains all data and algorithms required to run the sensor hardware. It is wrapped within an API that allows the user to access the internal functionality of the core library to control the device. The user application will basically access the core functionality via function calls through the API and has further the opportunity to install callbacks within the core in order to get informed about events in the library, e.g. new measurement data ready or other status changes.</p>
<p>The <em>AFBR-S50 Core Library</em> requires access to the hardware peripherals to communicate with the sensor device. Dedicated platform interfaces are defined by the API and need to be implemented by the user based on the underlying hardware platform.</p>
<p><a class="anchor" id="sw_architecture"></a></p><div class="image">
<img src="2_1_sw_architecture.png" alt=""/>
<div class="caption">
Fig. 2.1: An overview of the *AFBR-S50 SDK* architecture for integration into an user application.</div></div>
 <h1><a class="anchor" id="sw_api_principle"></a>
Operation Principle</h1>
<p>The basic operation principle of the <em>AFBR-S50 Core Library</em> is described below:</p>
<ul>
<li><a class="el" href="group__argus__meas.html">Measurement</a> routines are running asynchronously in the background and notify the user application via a callback when a measurement has finished and new raw measurement data is ready to be used. The measurements are triggered either by a periodic timer interrupt at a fixed frame rate or by a dedicated function call from the user application. The actual measurement sequence is driven by short interrupt service routines and therefore the main processor tasks are not blocked while measurements are ongoing.</li>
<li>The evaluation of the raw measurement data is executed independently of the measurement activity. When the main task is informed about the new raw measurement data ready event from the core by callback, it can call the evaluation routine whenever appropriate. However, the raw data buffer is blocked until the data is evaluated. Thus, not calling the evaluation routine blocks the start of new measurement frames. A double buffer architecture is utilized in order to allow interleaved execution of measurements and evaluation tasks.</li>
<li>After calling the <a class="el" href="group__argus__meas.html#ga2f130afc115837409b99efaaaf5baedf">evaluation routine</a>, the <a class="el" href="group__argus__res.html">Measurement Data</a> is ready and calibrated. The raw data buffer is empty and ready to be used with a new measurement frame to be performed on the device.</li>
<li>In order to adopt to different operating conditions in different user application cases, the <a class="el" href="group__argus__cfg.html">Configuration</a> or <a class="el" href="group__argus__cal.html">Calibration</a> parameters can be applied via the API layer. Default configuration and calibration data sets, called <a class="el" href="group__argus__api.html#gabe8846d7abef63b75e8147f4f142708b">Measurement Modes</a>, are provided for many use cases. These default settings can be fine tuned to the actual customers requirements.</li>
<li>The <a class="el" href="group__argus__dca.html">Dynamic Configuration Adaption (DCA)</a> feature is provided to automatically adopt to changing environment parameters, such as target reflectivity, ambient light or temperature. This feature highly increase the dynamic measurement range.</li>
<li>The final evaluated measurement data obtained from the API consists of 3D data, i.e. range and amplitude per pixel, as well as 1D data, i.e. range and amplitude evaluated from a certain number of pixels. The selection of the pixels to determine the 1D data is realized via the <a class="el" href="group__argus__pba.html">Pixel Binning Algorithm (PBA)</a> module.</li>
<li><a class="el" href="group__argus__cal.html">Calibration</a> algorithms are applied within the evaluation sequence and to the device configuration in order to compensate environmental influences or device-to-device deviations. Each device comes with its individual factory calibrated values in an EEPROM that is read and applied in by the <a class="el" href="group__argus__cal.html">Calibration</a> module.</li>
<li><em>Auxiliary</em> measurement tasks are utilized to obtain information about the system health and the environment (e.g. temperature or ambient light conditions) and adopt the system correspondingly. These measurements are automatically executed in the background after each measurement cycle.</li>
<li>A <a class="el" href="group__argus__dfm.html">Dual-Frequency Mode (DFM)</a> is provided to overcome the limited unambiguous range issue and remove ghost pictures.</li>
<li><b>Eye-Safety</b> is derived from the static default configuration and adopted to any configuration changes made via the API. Also the DCA module heeds the laser safety limits. A timeout will watch the system responsiveness and the <em>Reference Pixel</em> is used to monitor the health state of the laser source. A system shut down is triggered in case of any failure, e.g. a laser short circuit.</li>
</ul>
<h1><a class="anchor" id="sw_api_modules"></a>
API Modules</h1>
<p>The <em>AFBR-S50 Core Library</em> contains a comprehensive set of routines and algorithms to run the <em>AFBR-S50 Time-of-Flight Sensor</em> devices. The functions and objects are defined and implemented in the <a class="el" href="group__argus__api.html">AFBR-S50 Main API </a> module. It consists of several submodules that handle specified tasks, such as</p>
<ul>
<li><a class="el" href="group__argus__cfg.html">device configuration</a>,</li>
<li><a class="el" href="group__argus__cal.html">device calibration</a>,</li>
<li><a class="el" href="group__argus__res.html">measurement data evaluation</a> or</li>
<li><a class="el" href="group__argus__meas.html">generic/measurement operation</a>.</li>
</ul>
<p>In order to provide a <a class="el" href="porting_guide.html">portable API library</a>, the platform specific driver and HAL implementations are not included into the library. Instead, the connection to the hardware is obtained via the implementation of provided interfaces for the required hardware and peripherals. In detail, the hardware requirements are:</p>
<ul>
<li><a class="el" href="group__argus__s2pi.html">S2PI</a>: The communication with the device requires an SPI interface with additional GPIO capabilities. In order to increase speed and lower the CPU load, it is recommended to us a DMA module along with the SPI interface. In order to get informed about the measurement data ready event, a single GPIO IRQ is required and incorporated into the SPI module. In order to decrease the complexity for connections (in terms of wires required), the devices EEPROM is connected to the SPI pins but speaks a different protocol. In order to enable the calibration data readout from the EEPROM, the SPI pins must be accessed as GPIO pins in order to emulate the protocol by software <a href="https://en.wikipedia.org/wiki/Bit_banging">bit banging</a> algorithms. All these, i.e. SPI and GPIO, are summarized in the <a class="el" href="group__argus__s2pi.html">S2PI</a> module.</li>
<li><a class="el" href="group__argus__timer.html">Timer</a>: In order to heed the laser safety limits, a timer for time measurements concerns is mandatory. Note that this timer must be setup carefully in order to guarantee the laser safety to be within Class 1. Furthermore, a periodic interrupt timer can be used to trigger measurements autonomously in the background on a time based schedule. This is optional, since for simple implementations it might be sufficient to start the measurements on demand from the foreground threads by calling the corresponding API function.</li>
<li><a class="el" href="group__argus__irq.html">IRQ</a>: In order to prevent race conditions and such, the program must be able to lock the occurrence of interrupts in atomic or critical sections of the code.</li>
<li><a class="el" href="group__argus__log.html">Logger</a>: Optionally, the logger module can be implemented and utilized to obtain debug information from the API operation. This is done by a <em>printf</em>-like function.</li>
<li><a class="el" href="group__argus__nvm.html">Non-Volatile Memory</a>: If user calibration is used, it is recommended to implement the interface to access a non-volatile memory peripheral (e.g. flash memory). If implemented, the user calibration data (e.g. crosstalk vectors) can be stored within the <em>Core Library</em> and will be automatically reloaded after device initialization (e.g. after a power cycle). If not implemented, the user can manage the calibration and configuration via the API.</li>
</ul>
<p>Finally, there are some utilities implemented to help the user to adopt to the API architecture:</p>
<ul>
<li><a class="el" href="group__argus__fp.html">Fixed Point Math</a>: A small and effective fixed-point library containing essential algorithms and definitions.</li>
<li><a class="el" href="group__argus__time.html">Time Utilities</a>: Methods to handle the specified time format provided by the API.</li>
<li><a class="el" href="group__argus__misc.html">Misc. Utilities</a>: Miscellaneous Integer Math like long (64-bit) multiplication or integer square root. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath">
	<!-- id is needed for treeview function! -->
	<ul>
		<li class="footer"> 
			<a href="https://www.broadcom.com/">Broadcom Inc.</a>
		</li>
	</ul>
</div>
</body>
</html>
